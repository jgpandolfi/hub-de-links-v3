# =============================================================================
# .htaccess para Backend - Hub de Links
# Configurações completas de segurança para APIs e Painel Administrativo
# Desenvolvido por Jota / José Guilherme Pandolfi - Agência m2a
# hub.agenciam2a.com.br
# Versão do .htaccess desenvolvida para hospedagem em Hostgator Brasil (PHP-FPM)
# =============================================================================

# ----------------- CONFIGURAÇÕES ESSENCIAIS -----------------
# Ativar o motor de reescrita
RewriteEngine On

# Bloquear acesso a arquivos sensíveis e de configuração
<FilesMatch "^(\.htaccess|configuracao-banco\.php|security-headers\.php|csrf-protection\.php|verificar-sessao\.php|rate-limiter\.php|\.env|config.*\.php)$">
    Order deny,allow
    Deny from all
</FilesMatch>

# Bloquear acesso a todos os arquivos .md (documentação)
<FilesMatch "\.md$">
    Order deny,allow
    Deny from all
</FilesMatch>

# ----------------- BLOQUEIO TOTAL PARA CRAWLERS E BOTS -----------------
# Bloquear TODOS os bots e crawlers no backend
# Apenas usuários autenticados via navegador devem acessar

# Bloquear User-Agents de crawlers conhecidos
RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider|scraper|curl|wget|python|java|perl|ruby|httpclient|libwww|slurp|baiduspider|yandex|googlebot|bingbot|duckduckbot|facebook|twitter|linkedin|pinterest|instagram|whatsapp) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (GPTBot|CCBot|anthropic|PerplexityBot|ClaudeBot|Google-Extended|Applebot|Amazonbot) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^-$
RewriteRule ^(.*)$ - [F,L]

# ----------------- HEADERS DE SEGURANÇA GLOBAIS -----------------
<IfModule mod_headers.c>
    # Headers de segurança máxima
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "DENY"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "no-referrer"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
    
    # Content Security Policy - CORRIGIDO para permitir Ionicons
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://*.unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://unpkg.com https://*.unpkg.com https://cdn.jsdelivr.net; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
    
    # Headers específicos para APIs
    Header set Cache-Control "no-cache, no-store, must-revalidate, private"
    Header set Pragma "no-cache"
    Header set Expires "0"
</IfModule>

# ----------------- CONFIGURAÇÃO CORS RESTRITIVA -----------------
# CORS apenas para o próprio domínio (backend protegido)
<IfModule mod_headers.c>
    # Permitir apenas requisições do próprio domínio
    Header set Access-Control-Allow-Origin "https://hub.agenciam2a.com.br"
    Header set Access-Control-Allow-Methods "POST, GET, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token"
    Header set Access-Control-Allow-Credentials "true"
</IfModule>

# ----------------- TRATAMENTO DE REQUISIÇÕES OPTIONS -----------------
# Responder adequadamente às requisições de preflight
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=204,L]

# ----------------- PROTEÇÃO PAINEL ADMINISTRATIVO -----------------
# Bloquear arquivos PHP sensíveis do painel
<FilesMatch "^painel/(verificar-sessao|csrf-protection|security-headers)\.php$">
    Order deny,allow
    Deny from all
</FilesMatch>

# ----------------- ENDPOINTS DO PAINEL ADMINISTRATIVO -----------------
# Permitir acesso aos arquivos do painel (verificação de sessão é feita no PHP)
<Files "painel/dashboard.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/visitas.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/eventos.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/links-clicados.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/relatorios.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/gerar-relatorio.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/estilo-painel.css">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/script-painel.js">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/login.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/logout.php">
    Order allow,deny
    Allow from all
</Files>

<Files "painel/autenticacao.php">
    Order allow,deny
    Allow from all
</Files>

# ----------------- APIS PÚBLICAS (Tracking Frontend) -----------------
# APIs específicas de tracking
<Files "api/registrar-visita.php">
    Order allow,deny
    Allow from all
</Files>

<Files "api/registrar-evento.php">
    Order allow,deny
    Allow from all
</Files>

<Files "api/registrar-link-clicado.php">
    Order allow,deny
    Allow from all
</Files>

<Files "api/atualizar-sessao.php">
    Order allow,deny
    Allow from all
</Files>

# ----------------- FORÇAR HTTPS -----------------
# Redirecionar HTTP para HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ----------------- PROTEÇÃO CONTRA ATAQUES -----------------
# Proteção contra SQL Injection, XSS e outras injeções
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} (union|select|insert|update|delete|drop|create|alter|truncate|exec|declare) [NC,OR]
RewriteCond %{QUERY_STRING} (\.\./|\.\.\\|\.\.\%2F|%00|%0d%0a) [NC,OR]
RewriteCond %{QUERY_STRING} (localhost|127\.0\.0\.1|loopback|\:\:1) [NC,OR]
RewriteCond %{QUERY_STRING} (\%3C|\%3E|script|javascript|vbscript|eval|fromcharcode) [NC]
RewriteRule ^(.*)$ - [F,L]

# Proteção contra Path Traversal
RewriteCond %{REQUEST_URI} (\.\./|\.\.\\|%2e%2e) [NC]
RewriteRule ^(.*)$ - [F,L]

# Proteção contra acesso a arquivos de backup
RewriteCond %{REQUEST_URI} (\.bak|\.backup|\.old|\.orig|\.save|\.swp|~)$ [NC]
RewriteRule ^(.*)$ - [F,L]

# ----------------- CONFIGURAÇÕES DE CACHE -----------------
<IfModule mod_expires.c>
    ExpiresActive On
    
    # APIs e PHP - SEM cache
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType application/x-httpd-php "access plus 0 seconds"
    
    # CSS e JS do painel - cache curto
    ExpiresByType text/css "access plus 1 hour"
    ExpiresByType application/javascript "access plus 1 hour"
</IfModule>

# ----------------- COMPRESSÃO GZIP -----------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# ----------------- PÁGINAS DE ERRO PERSONALIZADAS -----------------
# Páginas de erro customizadas (se você criar)
ErrorDocument 400 /backend/erros/400.html
ErrorDocument 401 /backend/erros/401.html
ErrorDocument 403 /backend/erros/403.html
ErrorDocument 404 /backend/erros/404.html
ErrorDocument 429 /backend/erros/429.html
ErrorDocument 500 /backend/erros/500.html
ErrorDocument 503 /backend/erros/503.html

# ----------------- DESABILITAR LISTAGEM DE DIRETÓRIOS -----------------
Options -Indexes

# Prevenir acesso a arquivos ocultos
<FilesMatch "^\.">
    Order deny,allow
    Deny from all
</FilesMatch>

# ----------------- CONFIGURAÇÕES FINAIS -----------------
# Desabilitar server signature
ServerSignature Off

# Definir charset padrão
AddDefaultCharset UTF-8

# ----------------- FIM DO ARQUIVO .HTACCESS DO BACKEND -----------------